name: Security Pipeline

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  schedule:
    - cron: '0 2 * * 1'
  workflow_dispatch:
    inputs:
      scan_type:
        description: 'Type of security scan'
        required: true
        default: 'full'
        type: choice
        options:
          - full
          - quick
          - custom

permissions:
  contents: read
  security-events: write
  actions: read
  pull-requests: write

env:
  NODE_VERSION: '18'

jobs:
  setup:
    name: Setup and Validation
    runs-on: ubuntu-latest
    outputs:
      cache-key: steps.cache-key.outputs.key
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: 'npm'
      
      - name: Cache dependencies
        uses: actions/cache@v3
        id: cache-deps
        with:
          path: node_modules
          key: deps-${{ hashFiles('package-lock.json') }}
      
      - name: Install dependencies
        if: steps.cache-deps.outputs.cache-hit != 'true'
        run: npm ci
      
      - name: Validate project structure
        run: |
          echo "Validating project structure..."
          test -d src || (echo "src/ directory missing" && exit 1)
          test -f package.json || (echo "package.json missing" && exit 1)
          echo "Project structure valid"

  semgrep-scan:
    name: Semgrep SAST Analysis
    runs-on: ubuntu-latest
    needs: setup
    container:
      image: returntocorp/semgrep
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Run Semgrep with custom rules
        id: semgrep-custom
        run: |
          semgrep scan \
            --config semgrep-rules.yml \
            --config semgrep-advanced.yml \
            --json \
            --output custom-results.json \
            --metrics=off \
            --verbose
        continue-on-error: true
      
      - name: Run Semgrep OWASP Top 10
        id: semgrep-owasp
        run: |
          semgrep scan \
            --config "p/owasp-top-ten" \
            --json \
            --output owasp-results.json \
            --metrics=off
        continue-on-error: true
      
      - name: Generate SARIF report
        run: |
          semgrep scan \
            --config semgrep-rules.yml \
            --config semgrep-advanced.yml \
            --sarif \
            --output semgrep.sarif \
            --metrics=off
        continue-on-error: true
      
      - name: Upload SARIF to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: semgrep.sarif
          category: semgrep
      
      - name: Parse results
        if: always()
        run: |
          if [ -f custom-results.json ]; then
            CRITICAL=$(jq '[.results[] | select(.extra.severity == "ERROR")] | length' custom-results.json)
            HIGH=$(jq '[.results[] | select(.extra.severity == "WARNING")] | length' custom-results.json)
            TOTAL=$(jq '.results | length' custom-results.json)
            
            echo "CRITICAL_COUNT=$CRITICAL" >> $GITHUB_ENV
            echo "HIGH_COUNT=$HIGH" >> $GITHUB_ENV
            echo "TOTAL_COUNT=$TOTAL" >> $GITHUB_ENV
            
            echo "### Security Scan Results" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- Total Findings: $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- Critical: $CRITICAL" >> $GITHUB_STEP_SUMMARY
            echo "- High: $HIGH" >> $GITHUB_STEP_SUMMARY
          fi
      
      - name: Upload scan artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: semgrep-results
          path: |
            custom-results.json
            owasp-results.json
            semgrep.sarif
          retention-days: 30
      
      - name: Check blocking threshold
        if: always()
        run: |
          CRITICAL=${CRITICAL_COUNT:-0}
          if [ "$CRITICAL" -gt 0 ]; then
            echo "::error::Found $CRITICAL critical security issues"
            exit 1
          fi

  dependency-scan:
    name: Dependency Security Scan
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Run npm audit
        id: npm-audit
        run: |
          npm audit --json > npm-audit.json || true
          npm audit
        continue-on-error: true
      
      - name: Run Snyk test
        uses: snyk/actions/node@master
        continue-on-error: true
        env:
          SNYK_TOKEN: ${{ secrets.SNYK_TOKEN }}
        with:
          args: --severity-threshold=high --json-file-output=snyk-results.json
      
      - name: Upload dependency scan results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: dependency-scan-results
          path: |
            npm-audit.json
            snyk-results.json
          retention-days: 30

  code-quality:
    name: Code Quality Analysis
    runs-on: ubuntu-latest
    needs: setup
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Install dependencies
        run: npm ci
      
      - name: Run ESLint
        run: |
          npx eslint src/ --format json --output-file eslint-results.json || true
        continue-on-error: true
      
      - name: Run tests with coverage
        run: |
          npm test -- --coverage --coverageReporters=json || true
        continue-on-error: true
      
      - name: SonarCloud Scan
        uses: SonarSource/sonarcloud-github-action@master
        if: env.SONAR_TOKEN != ''
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        with:
          args: >
            -Dsonar.projectKey=owasp-top10-lab
            -Dsonar.organization=your-org
            -Dsonar.sources=src
            -Dsonar.tests=tests
      
      - name: Upload quality results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: code-quality-results
          path: |
            eslint-results.json
            coverage/
          retention-days: 30

  generate-reports:
    name: Generate Security Reports
    runs-on: ubuntu-latest
    needs: [semgrep-scan, dependency-scan, code-quality]
    if: always()
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
      
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
      
      - name: Install dependencies
        run: npm ci
      
      - name: Generate comprehensive report
        run: |
          if [ -f artifacts/semgrep-results/custom-results.json ]; then
            node scripts/parse-semgrep-results.js artifacts/semgrep-results/custom-results.json
          fi
      
      - name: Upload final reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: security-reports
          path: security-reports/
          retention-days: 90

  pr-comment:
    name: Comment on Pull Request
    runs-on: ubuntu-latest
    needs: [semgrep-scan]
    if: github.event_name == 'pull_request'
    
    steps:
      - name: Download Semgrep results
        uses: actions/download-artifact@v4
        with:
          name: semgrep-results
      
      - name: Generate PR comment
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            
            let comment = '## Security Scan Results\n\n';
            
            try {
              const results = JSON.parse(fs.readFileSync('custom-results.json', 'utf8'));
              const findings = results.results || [];
              
              const critical = findings.filter(f => f.extra?.severity === 'ERROR').length;
              const high = findings.filter(f => f.extra?.severity === 'WARNING').length;
              const total = findings.length;
              
              comment += `### Summary\n\n`;
              comment += `- **Total Findings:** ${total}\n`;
              comment += `- **Critical:** ${critical} :red_circle:\n`;
              comment += `- **High:** ${high} :orange_circle:\n\n`;
              
              if (critical > 0) {
                comment += `### :warning: Critical Issues\n\n`;
                findings
                  .filter(f => f.extra?.severity === 'ERROR')
                  .slice(0, 5)
                  .forEach(f => {
                    comment += `- **${f.check_id}**\n`;
                    comment += `  - File: \`${f.path}:${f.start.line}\`\n`;
                    comment += `  - ${f.extra?.metadata?.owasp || 'N/A'}\n\n`;
                  });
                
                if (critical > 5) {
                  comment += `\n_...and ${critical - 5} more critical issues_\n\n`;
                }
                
                comment += `**Action Required:** Please fix critical issues before merging.\n\n`;
              } else if (total === 0) {
                comment += `âœ… No security issues detected! Great job!\n\n`;
              }
              
              comment += `[View detailed report in workflow artifacts](https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId})\n`;
              
            } catch (error) {
              comment += `Error reading scan results: ${error.message}\n`;
            }
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    needs: [semgrep-scan, dependency-scan]
    if: always()
    
    steps:
      - name: Check security status
        run: |
          echo "Evaluating security gate..."
          
          if [ "${{ needs.semgrep-scan.result }}" == "failure" ]; then
            echo "::error::Semgrep scan failed with critical issues"
            exit 1
          fi
          
          echo "Security gate passed"

  notify:
    name: Send Notifications
    runs-on: ubuntu-latest
    needs: [semgrep-scan, dependency-scan, code-quality]
    if: always() && (github.ref == 'refs/heads/main' || github.event_name == 'schedule')
    
    steps:
      - name: Prepare notification
        run: |
          echo "Preparing security scan notification..."
          echo "Results: ${{ needs.semgrep-scan.result }}"
      
      - name: Slack notification
        if: env.SLACK_WEBHOOK != ''
        env:
          SLACK_WEBHOOK: ${{ secrets.SLACK_WEBHOOK }}
        run: |
          curl -X POST $SLACK_WEBHOOK \
            -H 'Content-Type: application/json' \
            -d '{
              "text": "Security Scan Completed",
              "blocks": [
                {
                  "type": "section",
                  "text": {
                    "type": "mrkdwn",
                    "text": "*Security Pipeline Results*\nBranch: '"$GITHUB_REF"'\nStatus: '"${{ needs.semgrep-scan.result }}"'"
                  }
                }
              ]
            }'